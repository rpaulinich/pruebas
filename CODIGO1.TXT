-- CODIGO POR RONAL PAULINICH

SELECT DISTINCT 
'20210531' AS PERIODO_CICLO,
CU_BILLING_CYCLE_KEY AS CICLO,
'SIGURD HUIDOBRO' AS SOLICITANTE,
'FACTURACION Y COBRANZAS' AS AREA_SOLICITANTE,
'CAMBIO DE PLAN ST' AS DESC_MENSAJE,
--CURRENT_DATE+3 AS FECHA_INICIO_PUBLICACION,
--CURRENT_DATE+28 AS FECHA_FIN_PUBLICACION,
TO_CHAR(CURRENT_DATE+3,'DD/MM/YYYY') AS FECHA_INICIO_PUBLICACION,
TO_CHAR(CURRENT_DATE+28,'DD/MM/YYYY') AS FECHA_FIN_PUBLICACION,
PRIMARY_RESOURCE_VALUE AS TELEFONO,
CASE
	WHEN TIPO_RENTA_ORIGEN = 'RENTA VENCIDA' AND TIPO_RENTA_DESTINO = 'RENTA VENCIDA' THEN 'El proximo mes visualizaras en tu recibo el monto de tu nuevo plan contratado S/ ' || TRIM(TO_CHAR(PRECIO_DESTINO_IGV,'999.99')) || '.'
	WHEN TIPO_RENTA_ORIGEN = 'RENTA VENCIDA' AND TIPO_RENTA_DESTINO = 'RENTA ADELANTADA' THEN 'Este mes se esta visualizando dos rentas en tu recibo, debido al cambio de plan que se registro el ' || CAST(CAST(OA_ORDER_ACTION_START_DATE AS DATE FORMAT 'DD/MM/YY') AS VARCHAR(8)) || ', es la renta vencida mes plan anterior y renta adelantada de nuevo plan.'
	WHEN TIPO_RENTA_ORIGEN = 'RENTA ADELANTADA' AND TIPO_RENTA_DESTINO = 'RENTA VENCIDA' THEN 'Este mes no se emite el monto de tu plan contratado, el proximo mes pagaras tu nuevo plan contratado S/ ' || TRIM(TO_CHAR(PRECIO_DESTINO_IGV,'999.99')) || '.'
	WHEN TIPO_RENTA_ORIGEN = 'RENTA ADELANTADA' AND TIPO_RENTA_DESTINO = 'RENTA ADELANTADA' THEN 'SIN MENSAJE'
END AS MENSAJE
--FROM ' || v_ESLVW || '.VW_ALDM_HdPrefRepCaplMT
FROM PE_PROD_ESL_VIEW.VW_ALDM_HdPrefRepCAPL
WHERE FLAG_REPORTE = 1
	--AND (TIPO_RENTA_ORIGEN NOT IN ('RENTA ADELANTADA') AND TIPO_RENTA_DESTINO NOT IN ('RENTA ADELANTADA'))
	AND MENSAJE NOT IN ('SIN MENSAJE')
	AND CU_BILLING_CYCLE_KEY = 31
